<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>글수정 - WAVE</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;background:#f7fafc;margin:0}
  header{background:#fff;padding:12px;border-bottom:1px solid #ddd}
  .container{max-width:800px;margin:20px auto;padding:12px}
  input,textarea{width:100%;padding:8px;border:1px solid #ddd;border-radius:6px;margin-bottom:8px}
  .btn{background:#0b69ff;color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
  #existingImages{display:flex;gap:8px;margin-bottom:8px;flex-wrap:wrap}
  #existingImages img{width:100px;height:70px;object-fit:cover;cursor:pointer;border:1px solid #ccc;border-radius:4px}
</style>
</head>
<body>
<header>
  <div style="max-width:800px;margin:0 auto;display:flex;justify-content:space-between;align-items:center">
    <div style="font-weight:800;color:#0b69ff">WAVE</div>
    <div><button onclick="location.href='index.html'" class="btn">홈</button></div>
  </div>
</header>

<div class="container">
  <h2>글 수정</h2>
  <form id="form">
    <input id="title" placeholder="제목">
    <textarea id="content" rows="8" placeholder="내용"></textarea>

    <label>이미지 첨부 (여러장 가능)</label>
    <input id="imageInput" type="file" accept="image/*" multiple>
    <div id="existingImages"></div>

    <div id="adminTimeRow" style="display:none">
      <label>작성일시 (관리자만)</label>
      <input id="manualTime" type="datetime-local">
    </div>

    <div style="display:flex;gap:8px">
      <button class="btn" type="submit">저장</button>
      <button type="button" onclick="location.href='index.html'" class="btn" style="background:#ccc;color:#222">취소</button>
    </div>
  </form>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getFirestore, doc, getDoc, updateDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCXBJyjdgekPMNKXFrznVrfLez04353zck",
  authDomain: "wave-free-community.firebaseapp.com",
  projectId: "wave-free-community",
  storageBucket: "wave-free-community.appspot.com",
  messagingSenderId: "1072639024866",
  appId: "1:1072639024866:web:934998f5e4a7eb02bd88bb"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

const params = new URLSearchParams(window.location.search);
const postId = params.get('id');
let currentUser = null;
let currentUserDoc = null;
let existingImages = [];

function displayExistingImages(urls){
  const container = document.getElementById('existingImages');
  container.innerHTML = '';
  urls.forEach((url, idx)=>{
    const img = document.createElement('img');
    img.src = url;
    img.dataset.idx = idx;
    img.addEventListener('click', ()=>{
      if(confirm('삭제하시겠습니까?')){
        existingImages.splice(idx,1);
        displayExistingImages(existingImages);
      }
    });
    container.appendChild(img);
  });
}

onAuthStateChanged(auth, async user=>{
  if(!user){ alert('로그인 후 이용가능'); location.href='index.html'; return; }
  currentUser = user;
  try{
    const uSnap = await getDoc(doc(db,'users',user.uid));
    if(uSnap.exists()) currentUserDoc = uSnap.data();
  }catch(e){ console.warn(e); }

  const snap = await getDoc(doc(db,'posts',postId));
  if(!snap.exists()){ alert('게시물 없음'); location.href='index.html'; return; }
  const p = snap.data();

  if (!(p.authorUid === currentUser.uid || p.authorId === currentUser.uid || (currentUserDoc && currentUserDoc.role === 'admin'))) {
    alert('권한 없음'); location.href='index.html'; return;
  }

  document.getElementById('title').value = p.title || '';
  document.getElementById('content').value = p.content || '';
  existingImages = p.images && p.images.length ? [...p.images] : (p.imageUrl ? [p.imageUrl] : []);
  displayExistingImages(existingImages);

  if(currentUserDoc && currentUserDoc.role === 'admin') document.getElementById('adminTimeRow').style.display='block';
});

async function uploadImage(file){
  const form = new FormData();
  form.append('file', file);
  form.append('upload_preset', "wavecm");
  const res = await fetch('https://api.cloudinary.com/v1_1/dlzhh9997/image/upload', { method:'POST', body:form });
  const data = await res.json();
  return data.secure_url || '';
}

document.getElementById('form').addEventListener('submit', async e=>{
  e.preventDefault();
  try{
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();

    const files = Array.from(document.getElementById('imageInput').files || []);
    const newImages = [];
    for(const f of files){
      try{
        const url = await uploadImage(f);
        if(url) newImages.push(url);
      }catch(err){ console.warn('업로드 실패', err); }
    }

    const updated = { title, content, images: [...existingImages, ...newImages] };
    const manual = document.getElementById('manualTime').value;
    if(manual) updated.createdAt = Timestamp.fromDate(new Date(manual));

    await updateDoc(doc(db,'posts',postId), updated);
    alert('수정 완료');
    location.href = `post.html?id=${postId}`;
  }catch(err){
    console.error('수정 오류', err);
    alert('수정 실패: ' + (err.message || err));
  }
});
</script>
</body>
</html>
